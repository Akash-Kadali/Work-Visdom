<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="color-scheme" content="light dark"/>
  <title>VISDOM ‚Ä¢ Verify</title>
  <meta name="description" content="Compare YOLO and CRNN OCR predictions, fix mismatches, and save verified results. Local-first, production UI."/>
  <meta name="theme-color" content="#0a1020"/>

  <!-- CSP (inline script required for the /verify_data fetch patch & page logic) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data: blob:;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src https://fonts.gstatic.com;
                 script-src 'self' 'unsafe-inline';
                 connect-src 'self';"/>

  <!-- Icon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='uploads/Logo4.png') }}"/>

  <!-- Fonts (optional; base app.css may already cover) -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>

  <!-- App CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}"/>

  <!-- Page layout + module cosmetics -->
  <style>
    :root{
      --sidebar-w: 240px;
      --surface-1: rgba(255,255,255,.06);
      --surface-2: rgba(255,255,255,.10);
      --text-3:   #98a1b3;
    }

    /* Layout shell */
    body{min-height:100vh; display:grid; grid-template-rows:auto 1fr; background:var(--bg,#0a1020);}
    header.appbar{
      position:sticky; top:0; z-index:100; display:flex; align-items:center; gap:1rem;
      padding:.75rem 1rem; background:rgba(0,0,0,.35); backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--surface-2);
    }
    header .brand{display:flex; align-items:center; gap:.6rem; text-decoration:none}
    header .env{font-size:.75rem; padding:.2rem .5rem; border:1px solid var(--surface-2); border-radius:999px}
    header .spacer{flex:1}

    .layout{display:grid; grid-template-columns: var(--sidebar-w) 1fr; min-height: calc(100vh - 56px);}
    aside.sidebar{
      border-right:1px solid var(--surface-2); padding:1rem .75rem; position:sticky; top:56px;
      height: calc(100vh - 56px); overflow:auto; background:rgba(255,255,255,.02);
    }
    .nav-section{margin-bottom:1.25rem}
    .nav-section h4{font-size:.75rem; text-transform:uppercase; letter-spacing:.08em; color:var(--text-3); margin:.25rem .5rem}
    .vnav{list-style:none; padding:0; margin:.25rem 0}
    .vnav a{display:flex; align-items:center; gap:.6rem; padding:.55rem .6rem; border-radius:.5rem; text-decoration:none}
    .vnav a[aria-current="page"]{background:var(--surface-1);}

    main.console{padding:1.25rem 1.25rem 2.5rem; overflow:auto;}
    .grid{display:grid; gap:1rem}
    .card{background:var(--surface-1); border:1px solid var(--surface-2); border-radius:16px; padding:1rem;}
    .muted{color:var(--text-3)}
    .sr-only{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden}

    /* Status lights */
    .light{display:inline-block; width:12px; height:12px; border-radius:50%; border:2px solid rgba(255,255,255,.28); margin-left:.4rem}
    .light.red{background:#ff4d4f}.light.orange{background:#ffa940}.light.yellow{background:#fadb14}.light.green{background:#52c41a}
    .status-inline{display:inline-block; min-height:1.25rem; margin-left:.5rem}

    /* Toolbar / buttons */
    .toolbar{display:flex; gap:1rem; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .btn{padding:.55rem .9rem; border-radius:.6rem; border:1px solid rgba(255,255,255,.16); background:#14151a; color:#fff; cursor:pointer}
    .btn:hover{filter:brightness(1.06)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn.ghost{background:transparent}
    .counter{opacity:.85}

    /* Banners */
    .banner{background:#0f2914; color:#b5f4b5; border:1px solid #1f6a2b; padding:.75rem 1rem; border-radius:12px; display:none}
    .banner.show{display:block}
    .banner.warn{background:#2a1a00; color:#ffd27a; border-color:#6a4b00}

    /* Viewer */
    .viewer{display:grid; gap:1rem; grid-template-columns: 1fr}
    @media (min-width: 1000px){ .viewer{grid-template-columns: minmax(0,1.6fr) minmax(0,1fr)} }

    .img-wrap{display:flex; align-items:center; justify-content:center; background:#0b0b0f; border:1px solid rgba(255,255,255,.1); border-radius:16px; min-height:360px}
    .img-wrap img{max-width:100%; max-height:70vh; display:block}

    .meta{display:grid; gap:.5rem; grid-template-columns: repeat(2, minmax(0,1fr))}
    .stat{font-size:.95rem; opacity:.9}
    .pill{display:inline-block; padding:.15rem .5rem; border-radius:999px; font-size:.85rem}
    .ok{background:#103; color:#8ef}
    .bad{background:#301; color:#feb}

    .verify-box{margin-top:1rem; padding:1rem; border:1px dashed rgba(255,255,255,.2); border-radius:12px; background:rgba(255,255,255,.02)}
    .verify-row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
    .code-input{padding:.55rem .7rem; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#0e0e0e; color:#fff; letter-spacing:.08em; text-transform:uppercase; width:10ch; text-align:center; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .hint{font-size:.82rem; opacity:.75}

    /* Toast */
    .toast{position:fixed; bottom:16px; right:16px; background:#14151a; color:#fff; padding:.6rem .8rem; border-radius:.6rem; opacity:0; transform:translateY(8px); transition:.25s; pointer-events:none; border:1px solid rgba(255,255,255,.15)}
    .toast.show{opacity:1; transform:translateY(0)}

    footer{padding:1rem; color:var(--text-3); border-top:1px solid var(--surface-2)}
    @media (max-width: 1024px){ :root{ --sidebar-w: 200px } }
  </style>
</head>

<body data-app="visdom" data-page="verify">
  <a class="sr-only" href="#content">Skip to content</a>

  <!-- Top App Bar -->
  <header class="appbar" role="banner">
    <a href="{{ url_for('index') }}" class="brand" aria-label="VISDOM Home">
      <img src="{{ url_for('static', filename='uploads/Logo_front.png') }}" alt="VISDOM Logo" width="44" height="30"/>
      <strong>VISDOM ‚Ä¢ Verify</strong>
      <span class="env">v{{ build_version|default('0.1.0') }}</span>
    </a>
    <span class="spacer"></span>

    <div class="top-actions" style="display:flex; gap:.75rem; align-items:center">
      <span class="muted">Status</span>
      <span id="master-light" class="light green" aria-label="Idle"></span>
      <span id="master-status" class="status-inline muted">Idle.</span>

      <!-- Safe shutdown (POST) -->
      <form action="{{ url_for('shutdown') }}" method="post">
        <button id="shutdown-btn" class="btn btn-danger" type="submit" title="Close VISDOM">‚èª Shutdown</button>
      </form>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Primary">
      <div class="nav-section">
        <h4>Overview</h4>
        <ul class="vnav">
          <li><a href="{{ url_for('index') }}">Home</a></li>
          <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <h4>Modules</h4>
        <ul class="vnav">
          <li><a href="{{ url_for('crop_page') }}">Crop</a></li>
          <li><a href="{{ url_for('ocr') }}">OCR</a></li>
          <li><a href="{{ url_for('verify_init') }}" aria-current="page">Compare</a></li>
          <li><a href="{{ url_for('inspection') }}">Inspection</a></li>
          <li><a href="{{ url_for('manual_inspection') }}">Manual Inspection</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <h4>Help</h4>
        <ul class="vnav">
          <li><a href="#" onclick="document.getElementById('toast').textContent='Docs coming soon';return false;">Documentation</a></li>
          <li><a href="#" onclick="document.getElementById('toast').textContent='Shortcuts: ‚Üê/‚Üí nav, Enter save';return false;">Keyboard Shortcuts</a></li>
        </ul>
      </div>
    </aside>

    <!-- Main console -->
    <main id="content" class="console" role="main">
      <!-- Intro + banners -->
      <section class="grid" aria-label="Intro">
        <div class="card">
          <h1 style="margin:.25rem 0 .25rem">Manual Verification</h1>
          <p class="muted">Compare <strong>YOLO</strong> and <strong>CRNN</strong> predictions for code crops, correct any mismatches, and save verified results to the backend.</p>
        </div>
        <div class="card">
          <h3>Paths</h3>
          <ul class="list-tight muted">
            <li>Code crops: <code>data/output/code/</code></li>
            <li>Results (source): <code>data/csv/ocr_results.csv</code></li>
            <li>Verified output: <code>data/csv/ocr_verified.csv</code></li>
          </ul>
          <p class="muted" style="margin-top:.5rem">Local filesystem only. No cloud.</p>
        </div>
      </section>

      <section class="card" aria-label="Status">
        <div id="all-ok" class="banner" role="status" aria-live="polite">üéâ All predictions match. Nothing to review.</div>
        <div id="empty" class="banner warn" role="status" aria-live="polite">No rows to show for the current filter.</div>
      </section>

      <!-- Toolbar -->
      <section class="card" aria-label="Navigation & Filters">
        <div class="toolbar">
          <div class="left">
            <button id="prev" class="btn" type="button" disabled>‚Üê Prev</button>
            <span class="counter" id="counter" aria-live="polite">0 / 0</span>
            <button id="next" class="btn" type="button" disabled>Next ‚Üí</button>
          </div>
          <div class="right" style="display:flex; gap:.5rem; flex-wrap:wrap">
            <button id="toggle-all" class="btn ghost" type="button" title="Show all rows (not only disagreements)">Show all rows</button>
            <button id="reload" class="btn ghost" type="button" title="Reload">Reload</button>
          </div>
        </div>
      </section>

      <!-- Viewer -->
      <section class="card viewer" aria-label="Reviewer">
        <div class="img-wrap">
          <img id="im" alt="code crop" loading="lazy" decoding="async"/>
        </div>
        <div class="info">
          <div class="meta">
            <div class="stat"><strong>Image:</strong> <span id="name">‚Äî</span></div>
            <div class="stat"><strong>Status:</strong> <span id="agree" class="pill ok">‚Äî</span></div>
            <div class="stat"><strong>YOLO:</strong> <span id="py">‚Äî</span></div>
            <div class="stat"><strong>CRNN:</strong> <span id="pc">‚Äî</span></div>
          </div>

          <!-- Manual input (visible only when disagree) -->
          <div id="verify-box" class="verify-box" style="display:none">
            <!-- IMPORTANT: id=verify-form-local so main.js doesn't bind its own listener -->
            <form id="verify-form-local" novalidate>
              <div class="verify-row">
                <label for="manual-code"><strong>Correct code:</strong></label>
                <input
                  id="manual-code"
                  class="code-input"
                  name="code"
                  type="text"
                  inputmode="latin"
                  autocomplete="off"
                  placeholder="XXXXXX"
                  minlength="6"
                  maxlength="6"
                  pattern="[0-9A-G]{6}"
                  required
                  aria-describedby="code-hint"
                />
                <button id="save-btn" class="btn" type="submit">Save</button>
                <button id="skip-btn" class="btn ghost" type="button" title="Go to next image">Skip</button>
                <span id="code-hint" class="hint">Allowed: 0‚Äì9, A‚ÄìG ¬∑ 6 chars</span>
              </div>
              <input type="hidden" id="img-name-hidden" name="image" value="">
            </form>
          </div>
        </div>
      </section>

      <noscript>
        <p class="muted" style="padding:1rem">JavaScript is required to load rows, save corrections, and show status.</p>
      </noscript>
    </main>
  </div>

  <!-- Global toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Ready.</div>

  <!-- Footer -->
  <footer role="contentinfo">
    <p class="muted">&copy; VISDOM ‚Äî Compare / Verify Module.</p>
  </footer>

  <!-- Page JS -->
  <script>
    // ---------- Patch /verify_data so images always resolve in LOCAL mode ----------
    (function(){
      const origFetch = window.fetch ? window.fetch.bind(window) : null;
      if (!origFetch) return;
      window.fetch = async function(input, init){
        const url = (typeof input === "string") ? input : (input && input.url) || "";
        if (url && url.indexOf("/verify_data") === 0) {
          const res = await origFetch(input, init);
          const clone = res.clone();
          let j = null;
          try { j = await clone.json(); } catch(_) {}
          if (j && Array.isArray(j.items)) {
            j.items.forEach(it=>{
              if (!it) return;
              if (!it.proxy_url) {
                if (it.img_path) {
                  it.proxy_url = "/local/" + encodeURI(it.img_path);
                } else if (it.image && !/^https?:\/\//i.test(it.image)) {
                  it.proxy_url = "/local/" + encodeURI(it.image);
                } else if (it.img_url) {
                  it.proxy_url = it.img_url;
                }
              }
            });
            return new Response(JSON.stringify(j), {
              status: res.status,
              statusText: res.statusText,
              headers: { "Content-Type": "application/json" }
            });
          }
          return res;
        }
        return origFetch(input, init);
      };
    })();

    // ---------- Page logic ----------
    (function(){
      const im     = document.getElementById('im');
      const nameEl = document.getElementById('name');
      const pyEl   = document.getElementById('py');
      const pcEl   = document.getElementById('pc');
      const agreeEl= document.getElementById('agree');

      const prev   = document.getElementById('prev');
      const next   = document.getElementById('next');
      const counter= document.getElementById('counter');
      const allOk  = document.getElementById('all-ok');
      const empty  = document.getElementById('empty');
      const toggle = document.getElementById('toggle-all');
      const reloadBtn = document.getElementById('reload');

      // Manual verify UI
      const verifyBox  = document.getElementById('verify-box');
      const verifyForm = document.getElementById('verify-form-local');
      const manualCode = document.getElementById('manual-code');
      const imgHidden  = document.getElementById('img-name-hidden');
      const saveBtn    = document.getElementById('save-btn');
      const skipBtn    = document.getElementById('skip-btn');

      let items = [];
      let idx = 0;
      let showingAll = false;

      // Toast
      const toast = document.getElementById('toast');
      const showToast = (msg, timeout=1500) => {
        if (!toast) return;
        toast.textContent = msg;
        toast.classList.add('show');
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>toast.classList.remove('show'), timeout);
      };

      const norm = (s) => String(s || "").replace(/\s+/g, "").toUpperCase();
      const isMismatch = (it) => norm(it?.pred_yolo) !== norm(it?.pred_crnn);

      function setCounter() {
        const total = items.length;
        counter.textContent = total ? `${idx+1} / ${total}` : `0 / 0`;
        prev.disabled = total === 0 || idx === 0;
        next.disabled = total === 0 || idx >= total - 1;
      }

      function showManualBox(show, imageName = "") {
        verifyBox.style.display = show ? "block" : "none";
        if (show) {
          imgHidden.value = imageName || "";
          manualCode.value = "";
          manualCode.focus();
        } else {
          imgHidden.value = "";
        }
      }

      function render() {
        const total = items.length;

        empty.classList.toggle('show', total === 0);
        if (total === 0) {
          im.removeAttribute('src');
          nameEl.textContent = '‚Äî';
          pyEl.textContent   = '‚Äî';
          pcEl.textContent   = '‚Äî';
          agreeEl.textContent = '‚Äî';
          agreeEl.className = 'pill ok';
          showManualBox(false);
          setCounter();
          return;
        }

        const it = items[idx];

        im.src = it.proxy_url || it.img_url || '';
        im.alt = it.image || 'code crop';
        im.onerror = () => {
          im.removeAttribute('src');
          console.warn('Image failed to load for', it.image, it);
        };

        nameEl.textContent = it.image || '‚Äî';
        pyEl.textContent   = it.pred_yolo || '‚Äî';
        pcEl.textContent   = it.pred_crnn || '‚Äî';

        // Compute agreement purely from predictions
        const agreeNow = !isMismatch(it);
        agreeEl.textContent = agreeNow ? 'YES' : 'NO';
        agreeEl.className   = 'pill ' + (agreeNow ? 'ok' : 'bad');

        showManualBox(!agreeNow, it.image || "");
        setCounter();
      }

      async function load(onlyDisagreements = true){
        try {
          const url = `/verify_data?only_disagreements=${onlyDisagreements ? '1':'0'}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          items = (data && data.items) || [];
          idx = 0;

          const all_ok = data && data.summary && data.summary.all_ok;
          allOk.classList.toggle('show', !!all_ok && onlyDisagreements);

          toggle.textContent = onlyDisagreements ? 'Show all rows' : 'Show only disagreements';
          render();
        } catch (e) {
          console.error(e);
          items = [];
          idx = 0;
          allOk.classList.remove('show');
          empty.classList.add('show');
          render();
        }
      }

      // POST /save_verifications with { corrections: { [image]: code } }
      async function postCorrections(imageName, code) {
        const payload = { corrections: { [imageName]: code } };
        const res = await fetch('/save_verifications', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          let msg = `HTTP ${res.status}`;
          try {
            const data = await res.json();
            msg = data.message || data.error || msg;
          } catch(_) {}
          throw new Error(msg);
        }
        return res.json().catch(()=>({}));
      }

      // Uppercase + restrict charset as user types
      manualCode.addEventListener('input', () => {
        manualCode.value = manualCode.value.toUpperCase().replace(/[^0-9A-G]/g,'');
      });

      // Save submission
      verifyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = (manualCode.value || "").toUpperCase().trim();
        const imageName = imgHidden.value || (items[idx] && items[idx].image) || "";

        if (!/^[0-9A-G]{6}$/.test(code)) {
          showToast("Enter 6 chars in 0‚Äì9 or A‚ÄìG.");
          manualCode.focus();
          return;
        }

        try {
          saveBtn.disabled = true;

          // (Optional UI nicety) blank the current image so it "goes away" instantly
          im.removeAttribute('src');

          await postCorrections(imageName, code);

          // Don't flip model agreement; just mark client-side and remove this item
          if (items[idx]) items[idx].user_fixed = true;

          // ALWAYS remove the current item (both modes)
          items.splice(idx, 1);

          showToast("‚úÖ Saved");

          // Decide next index and render / reload if needed
          if (items.length === 0) {
            // Reload current mode to get fresh list (may still contain other rows)
            await load(!showingAll);  // showingAll=false => only_disagreements
            return;
          }
          if (idx >= items.length) idx = Math.max(0, items.length - 1);
          render();
        } catch (err) {
          console.warn(err);
          showToast(`‚ùå ${err.message || 'Save failed'}`);
          // If we blanked the image and save failed, re-render current item
          render();
        } finally {
          saveBtn.disabled = false;
        }
      });

      // Skip: next item
      skipBtn.addEventListener('click', () => {
        if (idx < items.length - 1) { idx++; render(); }
      });

      // Keyboard helpers
      document.addEventListener('keydown', (e) => {
        if (verifyBox.style.display !== 'none' && e.key === 'Enter' && document.activeElement === manualCode) {
          e.preventDefault();
          verifyForm.requestSubmit();
          return;
        }
        if (e.key === 'ArrowLeft' && !prev.disabled) prev.click();
        if (e.key === 'ArrowRight' && !next.disabled) next.click();
      });

      // Nav
      prev.addEventListener('click', () => { if (idx > 0) { idx--; render(); }});
      next.addEventListener('click', () => { if (idx < items.length - 1) { idx++; render(); }});
      toggle.addEventListener('click', () => { showingAll = !showingAll; load(!showingAll); });
      reloadBtn.addEventListener('click', () => load(!showingAll));

      // initial load: only disagreements
      load(true);
    })();
  </script>

  <!-- Shared site JS -->
  <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</body>
</html>
