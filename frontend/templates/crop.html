<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>VISDOM • Crop</title>
  <meta name="description" content="Batch-crop laser dies and code from local input images, then split each die crop into Body/Critical/Laser PNGs. Local-first, production UI." />
  <meta name="theme-color" content="#0a1020" />

  <!-- CSP (safe for main.js + fonts) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self'; connect-src 'self';">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='uploads/Logo4.png') }}" />

  <!-- Fonts (optional if app.css already imports) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- App CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}" />

  <!-- Page layout tweaks (keep light; core styles live in app.css) -->
  <style>
    :root{
      --sidebar-w: 240px;
      --surface-1: rgba(255,255,255,.06);
      --surface-2: rgba(255,255,255,.10);
      --text-3: #98a1b3;
    }
    body{min-height:100vh; display:grid; grid-template-rows:auto 1fr; background:var(--bg,#0a1020);}
    header.appbar{
      position:sticky; top:0; z-index:100; display:flex; align-items:center; gap:1rem;
      padding:.75rem 1rem; background:rgba(0,0,0,.35); backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--surface-2);
    }
    header .brand{display:flex; align-items:center; gap:.6rem; text-decoration:none}
    header .env{font-size:.75rem; padding:.2rem .5rem; border:1px solid var(--surface-2); border-radius:999px}
    header .spacer{flex:1}
    .layout{display:grid; grid-template-columns: var(--sidebar-w) 1fr; min-height: calc(100vh - 56px);}
    aside.sidebar{
      border-right:1px solid var(--surface-2); padding:1rem .75rem; position:sticky; top:56px;
      height: calc(100vh - 56px); overflow:auto; background:rgba(255,255,255,.02);
    }
    .nav-section{margin-bottom:1.25rem}
    .nav-section h4{font-size:.75rem; text-transform:uppercase; letter-spacing:.08em; color:var(--text-3); margin:.25rem .5rem}
    .vnav{list-style:none; padding:0; margin:.25rem 0}
    .vnav a{display:flex; align-items:center; gap:.6rem; padding:.55rem .6rem; border-radius:.5rem; text-decoration:none}
    .vnav a[aria-current="page"]{background:var(--surface-1);}
    main.console{padding:1.25rem 1.25rem 2.5rem; overflow:auto;}
    .grid{display:grid; gap:1rem}
    .grid.cols-3{grid-template-columns: repeat(12,1fr)}
    .card{background:var(--surface-1); border:1px solid var(--surface-2); border-radius:12px; padding:1rem;}
    .card h3{margin:.25rem 0 .5rem}
    .muted{color:var(--text-3)}
    .list-tight{margin:.25rem 0 0; padding-left:1.1rem}
    .pill{display:inline-block; padding:.15rem .5rem; border-radius:999px; background:var(--surface-2); font-size:.7rem}
    .status-inline{display:inline-block; min-height:1.25rem; margin-left:.5rem}
    .light{display:inline-block; width:12px; height:12px; border-radius:50%; border:2px solid rgba(255,255,255,.28); margin-left:.4rem}
    .light.red{background:#ff4d4f}.light.orange{background:#ffa940}.light.yellow{background:#fadb14}.light.green{background:#52c41a}
    table{width:100%; border-collapse:separate; border-spacing:0}
    th, td{padding:.55rem .6rem; border-bottom:1px solid var(--surface-2); font-size:.95rem; text-align:left}
    tr:last-child td{border-bottom:0}
    .sr-only{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden}
    footer{padding:1rem; color:var(--text-3); border-top:1px solid var(--surface-2)}
    @media (max-width: 1024px){
      :root{ --sidebar-w: 200px; }
      .grid.cols-3{grid-template-columns: 1fr}
    }
  </style>
</head>

<body data-app="visdom">
  <a href="#content" class="sr-only">Skip to content</a>

  <!-- Top App Bar -->
  <header class="appbar" role="banner">
    <a href="{{ url_for('index') }}" class="brand">
      <img src="{{ url_for('static', filename='uploads/Logo_front.png') }}" alt="VISDOM" width="44" height="30" />
      <strong>VISDOM • Crop</strong>
      <span class="env">v{{ build_version|default('0.1.0') }}</span>
    </a>
    <span class="spacer"></span>

    <div class="top-actions" style="display:flex; gap:.75rem; align-items:center">
      <span class="muted">Status</span>
      <span id="master-light" class="light green" aria-label="Idle"></span>
      <span id="master-status" class="status-inline muted">Idle.</span>

      <form action="{{ url_for('shutdown') }}" method="post">
        <button id="shutdown-btn" class="btn btn-danger" type="submit" title="Close VISDOM">⏻ Shutdown</button>
      </form>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Primary">
      <div class="nav-section">
        <h4>Overview</h4>
        <ul class="vnav">
          <li><a href="{{ url_for('index') }}">Home</a></li>
          <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <h4>Modules</h4>
        <ul class="vnav">
          <li><a href="{{ url_for('crop_page') }}" aria-current="page">Crop</a></li>
          <li><a href="{{ url_for('ocr') }}">OCR</a></li>
          <li><a href="{{ url_for('verify_init') }}">Compare</a></li>
          <li><a href="{{ url_for('inspection') }}">Inspection</a></li>
          <li><a href="{{ url_for('manual_inspection') }}">Manual Inspection</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <h4>Help</h4>
        <ul class="vnav">
          <li><a href="#" onclick="document.getElementById('toast').textContent='Docs coming soon';return false;">Documentation</a></li>
          <li><a href="#" onclick="document.getElementById('toast').textContent='Shortcuts: Shift+R run';return false;">Keyboard Shortcuts</a></li>
        </ul>
      </div>
    </aside>

    <!-- Main console -->
    <main id="content" class="console" role="main">
      <section class="grid" aria-label="Intro">
        <div class="card">
          <h1 style="margin:.25rem 0 .25rem">Crop Laser Dies + Code</h1>
          <p class="muted">Reads images from <strong>local</strong> input folders, detects up to <strong>20 laser dies</strong> (left → right) and the best unique code (rotated 90° anticlockwise), then writes crops locally.</p>
          <ul class="list-tight muted">
            <li>Die crops: <code>&lt;original&gt;_laser_die_1.jpg … _laser_die_20.jpg</code></li>
            <li>Best code: <code>&lt;original&gt;_code.jpg</code></li>
          </ul>
        </div>

        <div class="card">
          <h3>Paths</h3>
          <ul class="list-tight muted">
            <li>Images: <code>data/images/</code></li>
            <li>Outputs: <code>data/output/</code></li>
            <li>CSVs: <code>data/csv/</code></li>
            <li>Temp: <code>data/tmp/</code></li>
          </ul>
          <p class="muted" style="margin-top:.5rem">Configured in backend; local filesystem only.</p>
        </div>
      </section>

      <!-- Actions -->
      <section class="grid cols-3" aria-label="Crop & Split">
        <!-- Crop job -->
        <div class="card" style="grid-column: span 6">
          <h3>Run Local Crop</h3>
          <p class="muted">Detects laser dies + best code from local input images. Idempotent: skips if no new images.</p>
          <form id="crop-drive-form" action="{{ url_for('crop_drive') }}" method="post" novalidate>
            <div style="display:flex; gap:.6rem; align-items:center; flex-wrap:wrap">
              <button type="submit" class="btn btn-primary" id="crop-drive-submit" data-runonce="true">
                Start Crop
              </button>
              <span id="crop-status" aria-live="polite" class="status-inline muted">Ready.</span>
            </div>
            <p class="muted" style="margin:.5rem 0 0">No uploads from the browser — everything runs server-side.</p>
          </form>
        </div>

        <!-- Split job -->
        <div class="card" style="grid-column: span 6">
          <h3>Split Die → Body / Critical / Laser (PNG)</h3>
          <p class="muted">For each of the 20 die crops, produce three <strong>lossless PNG</strong> crops and save to local folders.</p>
          <ul class="list-tight muted" style="margin:.35rem 0 .6rem">
            <li><strong>Body</strong>: right 70% → <code>_body.png</code></li>
            <li><strong>Critical</strong>: left 30% &amp; top 20% → <code>_critical.png</code></li>
            <li><strong>Laser</strong>: left 30% &amp; bottom 80% → <code>_laser.png</code></li>
          </ul>

          <form id="split-drive-form" action="{{ url_for('split_drive') }}" method="post" novalidate>
            <div style="display:flex; gap:.6rem; align-items:center; flex-wrap:wrap">
              <button type="submit" class="btn" id="split-drive-submit" data-runonce="true">
                Split Crops (PNG)
              </button>
              <span id="split-status" aria-live="polite" class="status-inline muted">Ready.</span>
            </div>
            <p class="muted" style="margin:.5rem 0 0">Lossless saves; idempotent when up-to-date.</p>
          </form>
        </div>
      </section>

      <!-- Next step -->
      <section class="card" aria-label="Next step">
        <h3>Next</h3>
        <p class="muted">After splitting, proceed to OCR or Compare:</p>
        <div style="display:flex; gap:.6rem; flex-wrap:wrap">
          <a class="btn" href="{{ url_for('ocr') }}">Go to OCR</a>
          <a class="btn" href="{{ url_for('verify_init') }}">Go to Compare</a>
          <a class="btn" href="{{ url_for('inspection') }}">Go to Inspection</a>
        </div>
      </section>

      <!-- Notes -->
      <section class="card" aria-label="Notes">
        <h3>Notes</h3>
        <ul class="list-tight muted">
          <li>Local-first I/O; no Google Drive required.</li>
          <li>Jobs are idempotent: if nothing new is detected, you’ll see “No new images.”</li>
          <li>All output filenames preserve original quality; PNG splits are lossless.</li>
        </ul>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Ready.</div>

  <!-- Footer -->
  <footer role="contentinfo">
    <p>&copy; VISDOM — Visual Inspection System for Defect Observation and Monitoring.</p>
  </footer>

  <!-- JS -->
  <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</body>
</html>
