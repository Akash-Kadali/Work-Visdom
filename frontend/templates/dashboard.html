<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>VISDOM • Dashboard</title>
  <meta name="description" content="VISDOM dashboard: browse local CSVs, filter rows, view defect percentages and consolidated defective images." />
  <meta name="theme-color" content="#0a1020" />

  <!-- Icon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='uploads/Logo4.png') }}" />

  <!-- Base app stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}"/>

  <!-- Page layout (light; core tokens live in app.css) -->
  <style>
    :root{
      --sidebar-w: 240px;
      --surface-1: rgba(255,255,255,.06);
      --surface-2: rgba(255,255,255,.10);
      --text-3: #98a1b3;
      --table-font:.82rem;
    }
    body{min-height:100vh; display:grid; grid-template-rows:auto 1fr; background:var(--bg,#0a1020);}
    header.appbar{
      position:sticky; top:0; z-index:100; display:flex; align-items:center; gap:1rem;
      padding:.75rem 1rem; background:rgba(0,0,0,.35); backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--surface-2);
    }
    header .brand{display:flex; align-items:center; gap:.6rem; text-decoration:none}
    header .env{font-size:.75rem; padding:.2rem .5rem; border:1px solid var(--surface-2); border-radius:999px}
    header .spacer{flex:1}

    .layout{display:grid; grid-template-columns: var(--sidebar-w) 1fr; min-height: calc(100vh - 56px);}
    aside.sidebar{
      border-right:1px solid var(--surface-2); padding:1rem .75rem; position:sticky; top:56px;
      height: calc(100vh - 56px); overflow:auto; background:rgba(255,255,255,.02);
    }
    .nav-section{margin-bottom:1.25rem}
    .nav-section h4{font-size:.75rem; text-transform:uppercase; letter-spacing:.08em; color:var(--text-3); margin:.25rem .5rem}
    .vnav{list-style:none; padding:0; margin:.25rem 0}
    .vnav a{display:flex; align-items:center; gap:.6rem; padding:.55rem .6rem; border-radius:.5rem; text-decoration:none}
    .vnav a[aria-current="page"]{background:var(--surface-1);}
    main.console{padding:1.25rem 1.25rem 2.5rem; overflow:auto;}
    .grid{display:grid; gap:1rem}

    .card{background:var(--surface-1); border:1px solid var(--surface-2); border-radius:16px; padding:1rem;}
    .hdr{display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-bottom:.5rem}
    .muted{color:var(--text-3)}
    .btn{padding:.55rem .9rem; border-radius:.6rem; border:1px solid rgba(255,255,255,.16); background:#14151a; color:#fff; cursor:pointer}
    .btn.alt{background:transparent}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    input[type=text], select{width:100%; padding:.5rem .65rem; border-radius:.6rem; border:1px solid rgba(255,255,255,.16); background:#0f1117; color:#e7e9ee}

    /* ===== Full-width rows + chip strip ===== */
    .row{display:grid; grid-template-columns:1fr; gap:1rem}
    .chiplist{display:flex; gap:.5rem; overflow-x:auto; padding:.25rem .25rem .35rem}
    .chiplist::-webkit-scrollbar{height:8px}
    .chiplist::-webkit-scrollbar-thumb{background:var(--surface-2); border-radius:999px}
    /* CSV buttons as chips in one horizontal row */
    #csv-list .btn.alt{display:inline-flex; flex:0 0 auto; white-space:nowrap}

    /* ===== Tables ===== */
    .list{max-height:none; overflow:auto; border:1px solid var(--surface-2); border-radius:12px}
    table{width:100%; border-collapse:separate; border-spacing:0; table-layout:auto; font-size:var(--table-font)}
    thead th{
      position:sticky; top:0; z-index:1; text-align:left; padding:.5rem .65rem;
      background:var(--surface-2); border-bottom:1px solid var(--surface-2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis
    }
    tbody td{
      padding:.5rem .65rem; border-bottom:1px solid var(--surface-2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis
    }
    tbody tr:hover{background:rgba(255,255,255,.04)}

    /* ===== Pies: full-width row, responsive size ===== */
    .pies{
      display:grid;
      grid-template-columns:repeat(3,minmax(220px,1fr));
      gap:1.25rem;
      align-items:start;
      justify-items:center;
      width:100%;
    }
    @media(max-width:900px){ .pies{grid-template-columns:repeat(2,minmax(200px,1fr))} }
    @media(max-width:560px){ .pies{grid-template-columns:1fr} }
    .pies > div{display:flex; flex-direction:column; align-items:center}
    .pie{
      width:clamp(160px,12vw,220px);
      height:clamp(160px,12vw,220px);
      border-radius:50%;
      display:grid; place-items:center; margin:0 auto;
      background:conic-gradient(#ff4d4f calc(var(--p,0)*1%), rgba(255,255,255,.1) 0)
    }
    .ring{
      width:calc(clamp(160px,12vw,220px) - 40px);
      height:calc(clamp(160px,12vw,220px) - 40px);
      border-radius:50%;
      background:var(--surface-1);
      box-shadow: inset 0 0 0 2px var(--surface-2)
    }
    .k{font-weight:700;text-align:center;margin-top:.35rem}

    /* Status + lights */
    .status{margin:.5rem 0 0; font-size:.9rem}
    .status.error{color:#ff4d4f}
    .light{display:inline-block; width:12px; height:12px; border-radius:50%; border:2px solid rgba(255,255,255,.28); margin-left:.4rem}
    .light.red{background:#ff4d4f}.light.orange{background:#ffa940}.light.yellow{background:#fadb14}.light.green{background:#52c41a}
    .status-inline{display:inline-block; min-height:1.25rem; margin-left:.5rem}

    .sr-only{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden}
    footer{padding:1rem; color:var(--text-3); border-top:1px solid var(--surface-2)}
  </style>

  <!-- CSP (inline script on this page only) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data: blob:;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src https://fonts.gstatic.com;
                 script-src 'self' 'unsafe-inline';
                 connect-src 'self';" />
</head>

<body data-app="visdom" data-page="dashboard">
  <a class="sr-only" href="#content">Skip to content</a>

  <!-- Top App Bar -->
  <header class="appbar" role="banner">
    <a href="{{ url_for('index') }}" class="brand" aria-label="VISDOM Home">
      <img src="{{ url_for('static', filename='uploads/Logo_front.png') }}" alt="VISDOM Logo" width="44" height="30" />
      <strong>VISDOM • Dashboard</strong>
      <span class="env">v{{ build_version|default('0.1.0') }}</span>
    </a>
    <span class="spacer"></span>

    <div class="top-actions" style="display:flex; gap:.75rem; align-items:center">
      <span class="muted">Status</span>
      <span id="master-light" class="light green" aria-label="Idle"></span>
      <span id="master-status" class="status-inline muted">Idle.</span>

      <form action="{{ url_for('shutdown') }}" method="post">
        <button id="shutdown-btn" class="btn btn-danger" type="submit" title="Close VISDOM">⏻ Shutdown</button>
      </form>
      <form id="export-die-form" style="display:flex; gap:.5rem; align-items:center">
        <button type="submit" id="export-die-btn" class="btn">Export Die Reports</button>
        <span id="export-die-status" class="subtle"></span>
      </form>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Primary">
      <div class="nav-section">
        <h4>Overview</h4>
        <ul class="vnav">
          <li><a href="{{ url_for('index') }}">Home</a></li>
          <li><a href="{{ url_for('dashboard') }}" aria-current="page">Dashboard</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <h4>Modules</h4>
        <ul class="vnav">
          <li><a href="{{ url_for('crop_page') }}">Crop</a></li>
          <li><a href="{{ url_for('ocr') }}">OCR</a></li>
          <li><a href="{{ url_for('verify_init') }}">Compare</a></li>
          <li><a href="{{ url_for('inspection') }}">Inspection</a></li>
          <li><a href="{{ url_for('manual_inspection') }}">Manual Inspection</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <h4>Help</h4>
        <ul class="vnav">
          <li><a href="#" onclick="document.getElementById('toast').textContent='Docs coming soon';return false;">Documentation</a></li>
          <li><a href="#" onclick="document.getElementById('toast').textContent='Shortcuts: / focus, ? help';return false;">Keyboard Shortcuts</a></li>
        </ul>
      </div>
    </aside>

    <!-- Main console -->
    <main id="content" class="console" role="main">
      <!-- Intro -->
      <section class="grid" aria-label="Intro">
        <div class="card">
          <h1 style="margin:.25rem 0 .25rem">Inspection Dashboard</h1>
          <p class="muted">Browse local CSVs, filter rows, view % defective, and see a consolidated list of defective images.</p>
        </div>
        <div class="card">
          <h3>Paths</h3>
          <ul class="list-tight muted">
            <li>CSVs: <code>data/csv/</code></li>
            <li>Images: <code>data/images/</code></li>
            <li>Outputs: <code>data/output/</code></li>
          </ul>
          <p class="muted" style="margin-top:.5rem">Local filesystem only. No cloud.</p>
        </div>
      </section>

      <!-- CSV picker (one horizontal row, full width) -->
      <section class="card" aria-label="CSV Picker">
        <div class="hdr" style="gap:.75rem;flex-wrap:wrap">
          <strong>Choose a CSV</strong>
          <span class="muted" id="csv-root">—</span>
          <span class="spacer"></span>
          <input id="csv-filter" type="text" placeholder="Filter file names…" style="max-width:320px">
          <button id="csv-reload" class="btn alt" type="button">Reload</button>
        </div>
        <div id="csv-list" class="chiplist" aria-label="CSV files strip"></div>
        <div id="status" class="status muted" aria-live="polite">Ready.</div>
      </section>

      <!-- Defect percentages (full width row) -->
      <section class="card" aria-label="Defect Percentages">
        <div class="hdr">
          <strong>Defect Percentages</strong>
          <span class="muted">% defective</span>
        </div>
        <div class="pies">
          <div>
            <div class="pie" id="pie-laser" style="--p:0"><div class="ring"></div></div>
            <div class="k">Laser: <span id="k-laser">0%</span></div>
          </div>
          <div>
            <div class="pie" id="pie-critical" style="--p:0"><div class="ring"></div></div>
            <div class="k">Critical: <span id="k-critical">0%</span></div>
          </div>
          <div>
            <div class="pie" id="pie-body" style="--p:0"><div class="ring"></div></div>
            <div class="k">Body: <span id="k-body">0%</span></div>
          </div>
        </div>
      </section>

      <!-- Selected CSV (full width row) -->
      <section class="card" aria-label="Selected CSV">
        <div class="hdr" style="gap:.75rem;flex-wrap:wrap">
          <strong id="csv-current">Open a CSV →</strong>
          <span class="spacer"></span>
          <input id="row-filter" type="text" placeholder="Filter rows across columns…" disabled style="max-width:360px">
          <button id="csv-clear" class="btn alt" type="button" disabled>Clear</button>
        </div>
        <div class="list">
          <table id="csv-table"><thead></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- All Defective Images (own full-width row) -->
      <section class="card" aria-label="All Defective Images">
        <div class="hdr">
          <strong>All Defective Images</strong>
          <button id="def-reload" class="btn alt" type="button">Reload</button>
        </div>

        <div class="row" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); align-items:center">
          <label>Region
            <select id="f-region">
              <option value="">All</option>
              <option value="laser">Laser</option>
              <option value="critical">Critical</option>
              <option value="body">Body</option>
            </select>
          </label>
          <label>Text
            <input id="f-text" type="text" placeholder="Substring…">
          </label>
        </div>

        <div class="list" style="margin-top:.75rem">
          <table id="def-table">
            <thead><tr><th>Region</th><th>Image</th><th>Consensus / Labels</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Ready.</div>

  <!-- Footer -->
  <footer role="contentinfo">
    <p class="muted">© VISDOM — Dashboard module.</p>
  </footer>

  <!-- Page JS (inline for this page) -->
  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const statusEl = $("#status");
    const setStatus = (t, isErr=false) => {
      statusEl.textContent = t || "";
      statusEl.className = "status" + (isErr ? " error" : " muted");
    };
    const esc = (v)=>String(v ?? "").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    const tail = (s, n=40)=>{ s=String(s||""); return s.length<=n ? s : "…" + s.slice(-n); };

    // ---------- CSV browser ----------
    const csvList   = $("#csv-list");
    const csvRoot   = $("#csv-root");
    const csvReload = $("#csv-reload");
    const csvFilter = $("#csv-filter");
    const csvTable  = $("#csv-table");
    const csvHead   = csvTable.querySelector("thead");
    const csvBody   = csvTable.querySelector("tbody");
    const rowFilter = $("#row-filter");
    const csvClear  = $("#csv-clear");
    const csvCurrent= $("#csv-current");

    let CSV_FILES = [];
    let CSV_ROWS = [];
    let CSV_COLS = [];

    function renderCsvList(){
      const q = (csvFilter.value||"").toLowerCase();
      csvList.innerHTML = "";
      const files = (CSV_FILES||[]).filter(f=>{
        const text = (f.rel || f.name || "").toLowerCase();
        return text.includes(q);
      });

      if (!files.length) {
        const p = document.createElement("p");
        p.className = "muted";
        p.style.margin = ".25rem .3rem";
        p.textContent = "No CSVs found. Check /api/csv/list and CSV_DIR.";
        csvList.appendChild(p);
        return;
      }

      files.forEach(f=>{
        const label = tail(f.rel || f.name, 48);
        const a = document.createElement("button");
        a.className = "btn alt";
        a.textContent = label;
        a.title = (f.rel || f.name) + (f.size ? ` (${f.size} bytes)` : "");
        a.addEventListener("click", ()=>openCsv(f.rel || f.name));
        a.addEventListener("keyup", (e)=>{ if(e.key==="Enter") a.click(); });
        csvList.appendChild(a);
      });
    }

    async function loadCsvList(){
      try{
        setStatus("Loading CSV list…");
        const r = await fetch("/api/csv/list");
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        CSV_FILES = j.files || [];
        csvRoot.textContent = j.root || "—";
        renderCsvList();
        setStatus(CSV_FILES.length ? `Found ${CSV_FILES.length} CSV file(s).` : "No CSVs found in folder.");
      }catch(e){
        setStatus("Failed to load CSV list. Is /api/csv/list available?", true);
        console.error(e);
        CSV_FILES = [];
        renderCsvList();
      }
    }

    function renderCsvTable(){
      const q = (rowFilter.value||"").toLowerCase();
      const rows = !q ? CSV_ROWS : CSV_ROWS.filter(r => Object.values(r).some(v => String(v||"").toLowerCase().includes(q)));
      csvHead.innerHTML = "";
      csvBody.innerHTML = "";
      if (!CSV_COLS.length) return;
      csvHead.innerHTML = `<tr>${CSV_COLS.map(c=>`<th title="${esc(c)}">${esc(c)}</th>`).join("")}</tr>`;
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = CSV_COLS.map(c=>{
          const val = esc(r[c]);
          return `<td title="${val}">${val}</td>`;
        }).join("");
        csvBody.appendChild(tr);
      });
    }

    async function openCsv(rel){
      try{
        setStatus(`Opening ${rel}…`);
        csvCurrent.textContent = tail(rel, 64);
        csvCurrent.title = rel;
        const r = await fetch(`/api/csv/get?rel=${encodeURIComponent(rel)}`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        CSV_COLS = j.columns || [];
        CSV_ROWS = j.rows || [];
        rowFilter.disabled = !CSV_COLS.length;
        csvClear.disabled = !CSV_COLS.length;
        renderCsvTable();
        setStatus(`Loaded ${CSV_ROWS.length} row(s) from ${rel}.`);
      }catch(e){
        setStatus(`Failed to open ${rel}.`, true);
        console.error(e);
        CSV_COLS = []; CSV_ROWS = [];
        renderCsvTable();
      }
    }

    csvReload.addEventListener("click", loadCsvList);
    csvFilter.addEventListener("input", renderCsvList);
    rowFilter.addEventListener("input", renderCsvTable);
    csvClear.addEventListener("click", ()=>{
      CSV_COLS = []; CSV_ROWS = [];
      csvHead.innerHTML = ""; csvBody.innerHTML = "";
      rowFilter.value = ""; rowFilter.disabled = true;
      csvCurrent.textContent = "Open a CSV →"; csvCurrent.removeAttribute("title");
      csvClear.disabled = true;
      setStatus("Cleared table.");
    });

    // ---------- Pies / Stats ----------
    function setPie(id, pct){
      const el = document.getElementById(id);
      el && el.style.setProperty("--p", Math.max(0, Math.min(100, +pct||0)));
    }
    async function loadStats(){
      try{
        const r = await fetch("/api/stats/defects");
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const s = await r.json();
        $("#k-laser").textContent = (s.laser?.pct_defective ?? 0) + "%";
        $("#k-critical").textContent = (s.critical?.pct_defective ?? 0) + "%";
        $("#k-body").textContent = (s.body?.pct_defective ?? 0) + "%";
        setPie("pie-laser", s.laser?.pct_defective ?? 0);
        setPie("pie-critical", s.critical?.pct_defective ?? 0);
        setPie("pie-body", s.body?.pct_defective ?? 0);
      }catch(e){
        console.warn("Stats error", e);
      }
    }

    // ---------- Defective list ----------
    const defBody = document.querySelector("#def-table tbody");
    const fRegion = $("#f-region");
    const fText   = $("#f-text");
    async function loadDefective(){
      try{
        const r = await fetch("/api/defective/list");
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        window.__DEF__ = j.items || [];
        renderDefective();
      }catch(e){
        console.warn("Defective list error", e);
        window.__DEF__ = [];
        renderDefective();
      }
    }
    function renderDefective(){
      const reg = fRegion.value;
      const q = (fText.value||"").toLowerCase();
      const items = (window.__DEF__ || []).filter(x=>{
        return (!reg || x.region === reg) &&
               (!q || JSON.stringify(x).toLowerCase().includes(q));
      });
      defBody.innerHTML = "";
      items.forEach(x=>{
        const consensus = x.consensus && x.consensus !== "MIXED"
          ? x.consensus
          : Object.entries(x.labels||{}).map(([k,v])=>`${k}:${v}`).join(", ");
        const tdRegion = esc(x.region);
        const fullImg  = String(x.image||"");
        const tdImage  = esc(tail(fullImg, 56));
        const tdCons   = esc(consensus);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td title="${tdRegion}">${tdRegion}</td>
                        <td title="${esc(fullImg)}">${tdImage}</td>
                        <td title="${tdCons}">${tdCons}</td>`;
        defBody.appendChild(tr);
      });
    }
    $("#def-reload").addEventListener("click", loadDefective);
    fRegion.addEventListener("change", renderDefective);
    fText.addEventListener("input", renderDefective);

    // Boot
    loadCsvList();
    loadStats();
    loadDefective();
  })();
  </script>

  <!-- Shared site JS -->
  <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</body>
</html>
